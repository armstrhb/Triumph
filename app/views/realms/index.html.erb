<html>
<head>
  <%= stylesheet_link_tag 'realms', :media => 'all' %>
</head>
<body>
  <div class="container">

    <ul class="nav nav-tabs nav-justified">
      <li role="presentation"><%= link_to "Triumph", url_for(:controller => 'realms', :action => 'index') %></li>
      <li role="presentation"><a href="#">Dashboard</a></li>
      <li role="presentation"><a href="#">Achievements</a></li>
      <% if logged_in? %>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <%= current_user.name %>
          </a>
          <ul class="dropdown-menu">
            <li><%= link_to "Profile", current_user %></li>
            <li><%= link_to "Sign out", logout_path, method: "delete" %>
          </ul>
        </li>
      <% else %>
        <li role="presentation"><%= link_to "Sign in", login_path %></li>
      <% end %>
    </ul>

    <div class="jumbotron">
      <h1>Welcome to Triumph.</h1>
      <button class="btn btn-lg btn-primary">HNNGH</button>
    </div>
    <hr>
    <p>You are currently a member of <%= pluralize(@realms.length, 'realm') %>.
      <button id="new-realm-button" class="btn" data-toggle="modal" data-target="#new-realm-modal">New Realm</button>
    </p>

    <div id="error-message" class="row collapse alert alert-danger" role="alert">
      <div class="col-lg-12 error-count-message">
        <h4>The following errors prevented realm creation:</h4>
        <ul>
          <% @new_realm.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    </div>

    <div id="success-message" class="row collapse alert alert-success" role="alert">
      <span class="message"></span>
    </div>

    <% if flash[:notice] %>
      <div class="row alert alert-info" role="alert">
        <%= flash[:notice] %>
      </div>
    <% end %>

    <table id="realm-table" class='table table-striped table-hover'>
      <tr>
        <th>Realm</th>
        <th class='text-center'>Users</th>
        <th class='text-center'>Achievements</th>
        <th class='text-center'>Points Earned</th>
        <th>Admin Group</th>
      </tr>
      <%= render @realms %>
    </table>
    <hr>

    <div class="row">
      <div class="col-lg-4">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Achievements in Progress</h3>
          </div><!--end panel-heading -->
        <p>Cheevs</p>
        </div><!--end panel-default -->
      </div><!-- end col-lg-4 -->

      <div class="col-lg-4">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Your Groups</h3>
          </div><!--end panel-heading -->
        <p>Cheevs</p>
        </div><!--end panel-default -->
      </div><!-- end col-lg-4 -->

      <div class="col-lg-4">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Hipster Ipsum</h3>
          </div><!--end panel-heading -->
        <p>Cheevs</p>
        </div><!--end panel-default -->
      </div><!-- end col-lg-4 -->
    </div><!-- end row -->

    <div id="new-realm-modal" class="modal fade" tabindex="-1" aria-labelledby="myModalLabel" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Create Realm</h4>
          </div>
          <div class="modal-body">
          <%= form_for(@new_realm, :html => { :id => "new_realm_form", :class => "form-inline"}, remote: true) do |f| %>
            <div class='form-group'>
              <%= f.label :name %>
              <%= f.text_field :name, :class => 'form-control' %>
              <!-- TODO admin group drop down -->
              <%= f.collection_select(:group_id, @groups.all, :id, :name, {}, {:class => 'form-control'}) %>
            </div>
            <%= f.submit :class => 'btn btn-primary' %>
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <% end %>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    $.fn.modal_success = function(){
        this.modal('hide');
        showSuccess();
    };

    $("tr[data-link]").click(function() {
      window.location = this.dataset.link;
    });

    $("#new_realm_form").on("ajax:error", function(event, xhr, status, error) {
      hideSuccess()
      handleErrors($.parseJSON(xhr.responseText));
    }).on("ajax:complete", function(xhr, status) {
      $('#new-realm-modal').modal('hide');
    }).on("ajax:beforeSend", function(event, xhr, settings) {
      $("#error-message").hide();
    });

    function showSuccess() {
      $("#success-message .message").html("Realm created.");
      $("#success-message").fadeIn(250);
    }

    function hideSuccess() {
      $("#success-message").hide();
    }

    function handleErrors(errors) {
      var errorDiv = $("#error-message");
      var errorList = errorDiv.find("ul");

      errorList.empty();
      for (var i = 0; i < errors.length; i++) {
        errorList.append($("<li>")
                 .append($("<span>", {class: "glyphicon glyphicon-exclamation-sign", "aria-hidden": true}))
                 .append($("<span>", {class: "sr-only"}))
                 .append($("<span>", {class: "error-item", html: errors[i]})));
      }

      if (errors.length > 0 && !errorDiv.is(":visible"))
        errorDiv.fadeIn(250);
    }

  </script>
</body>
</html>
